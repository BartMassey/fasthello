# IO Buffering performance in Rust
Bart Massey

This code is originally by `/u/bruce3434` on this Reddit
[thread](https://www.reddit.com/r/rust/comments/dogxk8/why_does_buffering_the_already_buffered_stdout/). The
fundamental issue was that dropping a `BufWriter` on top of
`StdoutLocked` sped the code up by a factor of 2× even
though the writes contained no newlines. This Reddit
[comment](https://www.reddit.com/r/rust/comments/dogxk8/why_does_buffering_the_already_buffered_stdout/f5oxnlg?utm_source=share&utm_medium=web2x)
explains what is going on; this codebase is the underlying
code being measured.

* `glacial.rs` uses unlocked `Stdout`. This is pretty slow
  due to all the locking.

* `slow.rs` uses `StdoutLocked`. This is still pretty slow,
  for reasons explained in the comment above.

* `fast.rs` uses a `BufWriter` atop `StdoutLocked`. This is
  the version that is 2× faster than the slow version.

* `speedy.rs` uses a `BufWriter` atop a raw UNIX `File`. It
  is about 10% faster than the fast version, but is portable
  only to UNIX systems and has an `unsafe` in it.

* `turbo.rs` is a fairly straightforward port of `turbo.c`,
  which avoids standard library routines for things in favor
  of hand-calculation. `turbo.rs` is about 60% faster than
  `speedy.rs`.
  
* `turbo.cpp` is another port of `turbo.c` contributed by
  Hossain Adnan. It's comparable in performance, depending
  on whether you use `gcc` / `clang` / `g++` / `clang++`.

* `vecbuf.rs` uses a manual buffer currently backed by 
  std::Vec::<u8>. Uses POSIX write to print to STDOUT.

* `mappy.rs` is a work-in-progress attempt to use
  memory-mapped I/O. It doesn't run yet.


## Perfomance comparison

Using [hyperfine](https://github.com/sharkdp/hyperfine), run
the executables generated by clang in the root directory and
the ones in `target/release/`. 

### Example

```
% hyperfine --warmup 2  ./turbo-c ./turbo-cpp ./target/release/vecbuf ./target/release/fast ./target/release/glacial ./target/release/slow ./target/release/speedy
Benchmark #1: ./turbo-c
  Time (mean ± σ):     711.1 ms ±   3.6 ms    [User: 697.5 ms, System: 13.2 ms]
  Range (min … max):   704.5 ms … 715.3 ms    10 runs
 
Benchmark #2: ./turbo-cpp
  Time (mean ± σ):     849.5 ms ±   6.1 ms    [User: 832.7 ms, System: 16.3 ms]
  Range (min … max):   834.4 ms … 856.1 ms    10 runs
 
Benchmark #3: ./target/release/vecbuf
  Time (mean ± σ):     986.8 ms ±  12.8 ms    [User: 965.4 ms, System: 21.0 ms]
  Range (min … max):   961.2 ms … 1009.4 ms    10 runs
 
Benchmark #4: ./target/release/fast
  Time (mean ± σ):      2.306 s ±  0.036 s    [User: 2.299 s, System: 0.006 s]
  Range (min … max):    2.273 s …  2.380 s    10 runs
 
Benchmark #5: ./target/release/glacial
  Time (mean ± σ):      9.075 s ±  0.116 s    [User: 8.926 s, System: 0.145 s]
  Range (min … max):    8.901 s …  9.237 s    10 runs
 
Benchmark #6: ./target/release/slow
  Time (mean ± σ):      5.488 s ±  0.031 s    [User: 5.353 s, System: 0.131 s]
  Range (min … max):    5.417 s …  5.532 s    10 runs
 
Benchmark #7: ./target/release/speedy
  Time (mean ± σ):      2.388 s ±  0.022 s    [User: 2.374 s, System: 0.011 s]
  Range (min … max):    2.367 s …  2.445 s    10 runs
 
 
Summary
  './turbo-c' ran
    1.19 ± 0.01 times faster than './turbo-cpp'
    1.39 ± 0.02 times faster than './target/release/vecbuf'
    3.24 ± 0.05 times faster than './target/release/fast'
    3.36 ± 0.04 times faster than './target/release/speedy'
    7.72 ± 0.06 times faster than './target/release/slow'
   12.76 ± 0.17 times faster than './target/release/glacial'
```