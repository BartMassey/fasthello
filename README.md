# IO Buffering performance in Rust
Bart Massey

This code is originally by `/u/bruce3434` on this Reddit
[thread](https://www.reddit.com/r/rust/comments/dogxk8/why_does_buffering_the_already_buffered_stdout/). The
fundamental issue was that dropping a `BufWriter` on top of
`StdoutLocked` sped the code up by a factor of 2× even
though the writes contained no newlines. This Reddit
[comment](https://www.reddit.com/r/rust/comments/dogxk8/why_does_buffering_the_already_buffered_stdout/f5oxnlg?utm_source=share&utm_medium=web2x)
explains what is going on; this codebase is the underlying
code being measured.

* `glacial.rs` uses unlocked `Stdout`. This is pretty slow
  due to all the locking.

* `slow.rs` uses `StdoutLocked`. This is still pretty slow,
  for reasons explained in the comment above.

* `fast.rs` uses a `BufWriter` atop `StdoutLocked`. This is
  the version that is 2× faster than the slow version.

* `speedy.rs` uses a `BufWriter` atop a raw UNIX `File`. It
  is about 10% faster than the fast version, but is portable
  only to UNIX systems and has an `unsafe` in it.

* `turbo.rs` is a fairly straightforward port of `turbo.c`,
  which avoids standard library routines for things in favor
  of hand-calculation. `turbo.rs` is about 60% faster than
  `speedy.rs`.
  
* `turbo.cpp` is another port of `turbo.c` contributed by
  Hossain Adnan. It's comparable in performance, depending
  on whether you use `gcc` / `clang` / `g++` / `clang++`.

* `vecbuf.rs` uses a manual buffer currently backed by 
  `std::Vec::<u8>`. Uses POSIX write to print to STDOUT.

* `mappy.rs` is a work-in-progress attempt to use
  memory-mapped I/O. It doesn't run yet.


## Perfomance comparison

Using [hyperfine](https://github.com/sharkdp/hyperfine), run
the executables generated by clang in the root directory and
the ones in `target/release/`. 

### Example

```
  % hyperfine --warmup 2  ./turbo-c ./turbo-cpp ./target/release/vecbuf ./target/release/turbo ./target/release/fast ./target/release/glacial ./target/release/slow ./target/release/speedy
Benchmark #1: ./turbo-c
  Time (mean ± σ):     715.0 ms ±   4.3 ms    [User: 692.8 ms, System: 22.0 ms]
  Range (min … max):   707.9 ms … 720.7 ms    10 runs
 
Benchmark #2: ./turbo-cpp
  Time (mean ± σ):     845.6 ms ±   6.1 ms    [User: 823.4 ms, System: 21.8 ms]
  Range (min … max):   837.2 ms … 859.1 ms    10 runs
 
Benchmark #3: ./target/release/vecbuf
  Time (mean ± σ):     988.3 ms ±   9.6 ms    [User: 972.4 ms, System: 15.6 ms]
  Range (min … max):   972.0 ms … 999.4 ms    10 runs
 
Benchmark #4: ./target/release/turbo
  Time (mean ± σ):      1.289 s ±  0.011 s    [User: 1.265 s, System: 0.023 s]
  Range (min … max):    1.275 s …  1.303 s    10 runs
 
Benchmark #5: ./target/release/fast
  Time (mean ± σ):      2.341 s ±  0.047 s    [User: 2.335 s, System: 0.005 s]
  Range (min … max):    2.289 s …  2.416 s    10 runs
 
Benchmark #6: ./target/release/glacial
  Time (mean ± σ):      9.158 s ±  0.142 s    [User: 9.022 s, System: 0.132 s]
  Range (min … max):    8.935 s …  9.371 s    10 runs
 
Benchmark #7: ./target/release/slow
  Time (mean ± σ):      5.502 s ±  0.032 s    [User: 5.367 s, System: 0.131 s]
  Range (min … max):    5.452 s …  5.553 s    10 runs
 
Benchmark #8: ./target/release/speedy
  Time (mean ± σ):      2.384 s ±  0.012 s    [User: 2.372 s, System: 0.011 s]
  Range (min … max):    2.364 s …  2.401 s    10 runs
 
Summary
  './turbo-c' ran
    1.18 ± 0.01 times faster than './turbo-cpp'
    1.38 ± 0.02 times faster than './target/release/vecbuf'
    1.80 ± 0.02 times faster than './target/release/turbo'
    3.27 ± 0.07 times faster than './target/release/fast'
    3.33 ± 0.03 times faster than './target/release/speedy'
    7.69 ± 0.06 times faster than './target/release/slow'
   12.81 ± 0.21 times faster than './target/release/glacial'
```